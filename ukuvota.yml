---
- name: Update and run Ukuvota
  hosts: localhost
  gather_facts: false

  vars:
    github_user: "waotzi"
    github_repo: "ukuvota"
    backup_dir: "/root/backups/ukuvota"
    current_datetime: "{{ ansible_date_time.iso8601_basic }}"
    backup_filename: "db_backup_{{ current_datetime }}.zip"

  tasks:
    - name: Get Artifact ID
      shell: "gh api -H 'Accept: application/vnd.github+json' -H 'X-GitHub-Api-Version: 2022-11-28' /repos/{{ github_user }}/{{ github_repo }}/actions/artifacts | jq '.artifacts[0].id'"
      register: artifact_id

    - name: Get Archive Download URL
      shell: "gh api -H 'Accept: application/vnd.github+json' -H 'X-GitHub-Api-Version: 2022-11-28' /repos/{{ github_user }}/{{ github_repo }}/actions/artifacts/{{ artifact_id.stdout }}/zip | jq -r '.url'"
      register: archive_url

    - name: Save the artifact to /tmp
      get_url:
        url: "{{ archive_url.stdout }}"
        dest: /tmp/ukuvota.zip
        
    - name: Backup database
      shell: "cd /var/www/ukuvota.world && zip -r {{ backup_dir }}/{{ backup_filename }} db"
      register: db_backup

    - name: Unzip artifact to /var/www/ukuvota.world
      unarchive:
        src: /tmp/ukuvota.zip
        dest: /var/www/ukuvota.world
        remote_src: yes
        extra_opts: [--overwrite]
      when: db_backup|success

    - name: Restart the application
      command: pm2 restart 0
      when: db_backup|success.changed
